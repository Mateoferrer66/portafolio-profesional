---
// Learn about using Astro layouts:
// https://docs.astro.build/en/core-concepts/layouts/

// Component Imports
import GoogleAnalytics from "../components/GoogleAnalytics.astro";
import GoogleTagManager from "../components/GoogleTagManager.astro";
import GoogleTagManagerNoScript from "../components/GoogleTagManagerNoScript.astro";
import MainHead from "../components/MainHead.astro";
import Nav from "../components/Nav.astro";
import Footer from "../components/Footer.astro";
import WhatsAppButton from "../components/WhatsAppButton.astro";
import ThreeDBackground from "../components/ThreeDBackground";
import { ViewTransitions } from "astro:transitions";
import ScrollReveal from "../components/ScrollReveal.astro";
import ScrollToTop from "../components/ScrollToTop.astro";
import ChatWidget from "../components/ChatWidget";
import MagicCursor from "../components/MagicCursor";
import FAQSchema from "../components/FAQSchema.astro";

interface Props {
	title?: string | undefined;
	description?: string | undefined;
	robots?: string | undefined;
	keywords?: string | undefined;
	image?: string | undefined;
}

const { title, description, robots, keywords, image } = Astro.props;
// Logic for Floating Buttons Stacking
const { pathname } = Astro.url;
const isHome = pathname === "/" || pathname === "";
const isWork = pathname.startsWith("/work");
const isAbout = pathname.startsWith("/about");
const isShop = pathname.startsWith("/shop");
const shouldStack = isHome || isWork || isAbout || isShop;

const chatWidgetClass = shouldStack
	? "relative flex flex-col items-end gap-4" // Stacked: Relative to container
	: undefined; // Default: Fixed positioning (handled by default prop)
---

<html lang="en">
	<head>
		<ViewTransitions />
		<!-- Google Tag Manager -->
		<GoogleTagManager />
		<!-- Google analytics code -->
		<GoogleAnalytics />
		<MainHead
			title={title}
			description={description}
			robots={robots}
			keywords={keywords}
			image={image}
		/>
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@graph": [
					{
						"@type": "Person",
						"name": "Mateo Ferrer",
						"url": "https://mateoferrer.com",
						"image": "https://mateoferrer.com/assets/portrait.jpg",
						"sameAs": [
							"https://twitter.com/mateoferrer66",
							"https://github.com/Mateoferrer66",
							"https://www.linkedin.com/in/mateo-ferrer-a679a713a/"
						],
						"jobTitle": "Desarrollador Web & Emprendedor",
						"worksFor": {
							"@type": "Organization",
							"name": "Freelance"
						}
					},
					{
						"@type": "ProfessionalService",
						"name": "Mateo Ferrer - Servicios Digitales",
						"url": "https://portafolio-profesional.pages.dev/",
						"image": "https://portafolio-profesional.pages.dev/assets/og-image.jpg",
						"description": "Desarrollo de sitios web, aplicaciones y venta de recursos digitales.",
						"address": {
							"@type": "PostalAddress",
							"addressCountry": "CO"
						},
						"priceRange": "$$"
					}
				]
			}
		</script>
		<FAQSchema />
		<slot name="head" />
	</head>
	<body>
		<GoogleTagManagerNoScript />
		<div id="scroll-progress"></div>
		<ThreeDBackground client:load />
		<div class="stack gap-20 backgrounds">
			<Nav />
			<slot />
			<Footer />
		</div>

		<div id="floating-buttons" class:list={[{ stacked: shouldStack }]}>
			<WhatsAppButton />
			<ChatWidget client:load className={chatWidgetClass} />
		</div>

		<ScrollReveal />
		<ScrollToTop />
		<MagicCursor client:only="react" />

		<script>
			// Add “loaded” class once the document has completely loaded.
			addEventListener("load", () =>
				document.documentElement.classList.add("loaded"),
			);

			// Scroll Progress Bar Logic
			window.addEventListener("scroll", () => {
				const winScroll =
					document.body.scrollTop ||
					document.documentElement.scrollTop;
				const height =
					document.documentElement.scrollHeight -
					document.documentElement.clientHeight;
				const scrolled = (winScroll / height) * 100;
				const progressBar = document.getElementById("scroll-progress");
				if (progressBar) {
					progressBar.style.width = scrolled + "%";
				}
			});
		</script>

		<style>
			#scroll-progress {
				position: fixed;
				top: 0;
				left: 0;
				width: 0%;
				height: 3px;
				background: var(--gradient-stroke);
				z-index: 10000;
				transition: width 0.1s ease-out;
				box-shadow: 0 0 10px var(--accent-regular);
			}

			:root {
				--_placeholder-bg: linear-gradient(transparent, transparent);
				--bg-image-main: url("/assets/backgrounds/bg-main-light-800w.jpg");
				--bg-image-main-curves: url("/assets/backgrounds/bg-main-light.svg");
				--bg-image-subtle-1: var(--_placeholder-bg);
				--bg-image-subtle-2: var(--_placeholder-bg);
				--bg-image-footer: var(--_placeholder-bg);
				--bg-svg-blend-mode: overlay;
				--bg-blend-mode: darken;
				--bg-image-aspect-ratio: 2.25;
				--bg-scale: 1.68;
				--bg-aspect-ratio: calc(
					var(--bg-image-aspect-ratio) / var(--bg-scale)
				);
				--bg-gradient-size: calc(var(--bg-scale) * 100%);
			}

			:root.theme-dark {
				--bg-image-main: url("/assets/backgrounds/bg-main-dark-800w.jpg");
				--bg-image-main-curves: url("/assets/backgrounds/bg-main-dark.svg");
				--bg-svg-blend-mode: darken;
				--bg-blend-mode: lighten;
			}

			/* These backgrounds are displayed below the fold, so we lazy load them
			   once the `.loaded` class has been set.  */
			:root.loaded {
				--bg-image-subtle-1: url("/assets/backgrounds/bg-subtle-1-light-800w.jpg");
				--bg-image-subtle-2: url("/assets/backgrounds/bg-subtle-2-light-800w.jpg");
				--bg-image-footer: url("/assets/backgrounds/bg-footer-light-800w.jpg");
			}
			:root.loaded.theme-dark {
				--bg-image-subtle-1: url("/assets/backgrounds/bg-subtle-1-dark-800w.jpg");
				--bg-image-subtle-2: url("/assets/backgrounds/bg-subtle-2-dark-800w.jpg");
				--bg-image-footer: url("/assets/backgrounds/bg-footer-dark-800w.jpg");
			}

			@media (min-width: 50em) {
				:root {
					--bg-scale: 1;
					--bg-image-main: url("/assets/backgrounds/bg-main-light-1440w.jpg");
				}
				:root.theme-dark {
					--bg-image-main: url("/assets/backgrounds/bg-main-dark-1440w.jpg");
				}

				:root.loaded {
					--bg-image-subtle-1: url("/assets/backgrounds/bg-subtle-1-light-1440w.jpg");
					--bg-image-subtle-2: url("/assets/backgrounds/bg-subtle-2-light-1440w.jpg");
					--bg-image-footer: url("/assets/backgrounds/bg-footer-light-1440w.jpg");
				}
				:root.loaded.theme-dark {
					--bg-image-subtle-1: url("/assets/backgrounds/bg-subtle-1-dark-1440w.jpg");
					--bg-image-subtle-2: url("/assets/backgrounds/bg-subtle-2-dark-1440w.jpg");
					--bg-image-footer: url("/assets/backgrounds/bg-footer-dark-1440w.jpg");
				}
			}

			.backgrounds {
				min-height: 100%;
				isolation: isolate;
				background: none;
				background-blend-mode: none;
				--bg-gradient-size: none;
			}
			@media (forced-colors: active) {
				/* Deactivate custom backgrounds for high contrast users. */
				.backgrounds {
					background: none;
					background-blend-mode: none;
					--bg-gradient-size: none;
				}
			}

			/* Floating Buttons Container */
			#floating-buttons {
				pointer-events: none; /* Let clicks pass through container */
			}

			#floating-buttons > * {
				pointer-events: auto; /* Re-enable pointer events for children */
			}

			#floating-buttons.stacked {
				position: fixed;
				bottom: 5px;
				right: 20px;
				z-index: 5000;
				display: flex;
				flex-direction: column;
				gap: 15px;
				align-items: flex-end;
			}
		</style>
	</body>
</html>
