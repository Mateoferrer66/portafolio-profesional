---
import { getCollection } from "astro:content";

import BaseLayout from "../layouts/BaseLayout.astro";

import ContactCTA from "../components/ContactCTA.astro";
import PortfolioPreview from "../components/PortfolioPreview.astro";
import Hero from "../components/Hero.astro";
import Grid from "../components/Grid.astro";

const allProjects = (await getCollection("work")).sort(
	(a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

// Group projects by category
const courseProjects = allProjects.filter((p) => p.data.category === "courses");
const personalProjects = allProjects.filter(
	(p) => p.data.category === "personal",
);
const clientProjects = allProjects.filter(
	(p) => p.data.category === "client-work",
);

const allTags = allProjects.flatMap((p) => p.data.tags || []);
const tagCounts = allTags.reduce(
	(acc, tag) => {
		acc[tag] = (acc[tag] || 0) + 1;
		return acc;
	},
	{} as Record<string, number>,
);
const topTags = Object.keys(tagCounts)
	.sort((a, b) => {
		const diff = tagCounts[b] - tagCounts[a];
		if (diff !== 0) return diff;
		return a.localeCompare(b);
	})
	.slice(0, 10);
---

<BaseLayout
	title="My Work | Mateo Ferrer"
	description="Explore my portfolio of professional projects, courses, and personal work"
>
	<div class="stack gap-20">
		<main class="wrapper stack gap-8">
			<Hero
				title="My Work"
				tagline="Explore my comprehensive portfolio of client projects, educational courses, and personal initiatives."
				align="start"
			/>

			<!-- Search Bar -->
			<div class="search-container">
				<input
					type="text"
					id="work-search"
					placeholder="Search projects..."
				/>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					class="search-icon"
				>
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
			</div>

			<!-- Filter Tags -->
			<div class="filter-container">
				<button class="filter-tag active" data-tag="all">All</button>
				{
					topTags.map((tag) => (
						<button class="filter-tag" data-tag={tag}>
							{tag}
						</button>
					))
				}
			</div>

			<!-- Cursos de React Section -->
			{
				courseProjects.length > 0 && (
					<section class="category-section">
						<header class="section-header">
							<h2 class="section-title">
								<span class="icon">ðŸ“š</span> Cursos
							</h2>
							<p class="section-description">
								Comprehensive training courses covering
								fundamentals to advanced topics.
							</p>
						</header>
						<Grid variant="offset">
							{courseProjects.map((project) => (
								<li class="project-item">
									<PortfolioPreview project={project} />
								</li>
							))}
						</Grid>
					</section>
				)
			}

			<!-- Personal Projects Section -->
			{
				personalProjects.length > 0 && (
					<section class="category-section">
						<header class="section-header">
							<h2 class="section-title">
								<span class="icon">ðŸš€</span> Personal Projects
							</h2>
							<p class="section-description">
								Innovative personal initiatives including
								Freelance work, MilMexico, and Tradership.
							</p>
						</header>
						<Grid variant="offset">
							{personalProjects.map((project) => (
								<li class="project-item">
									<PortfolioPreview project={project} />
								</li>
							))}
						</Grid>
					</section>
				)
			}

			<!-- Client Work Section -->
			{
				clientProjects.length > 0 && (
					<section class="category-section">
						<header class="section-header">
							<h2 class="section-title">
								<span class="icon">ðŸ’¼</span> Client Projects
							</h2>
							<p class="section-description">
								Professional work delivered for clients,
								showcasing real-world solutions.
							</p>
						</header>
						<Grid variant="offset">
							{clientProjects.map((project) => (
								<li class="project-item">
									<PortfolioPreview project={project} />
								</li>
							))}
						</Grid>
					</section>
				)
			}
		</main>
		<ContactCTA />
	</div>
</BaseLayout>

<script>
	const filterTags = document.querySelectorAll(".filter-tag");
	const projectItems = document.querySelectorAll(".project-item");
	const sections = document.querySelectorAll(".category-section");
	const searchInput = document.getElementById(
		"work-search",
	) as HTMLInputElement;

	function filterProjects() {
		const activeTagBtn = document.querySelector(".filter-tag.active");
		const activeTag = activeTagBtn
			? activeTagBtn.getAttribute("data-tag")
			: "all";
		const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

		// Show/Hide projects
		projectItems.forEach((item) => {
			const card = item.querySelector(".card");
			const title =
				card?.querySelector(".title")?.textContent?.toLowerCase() || "";
			const projectTags =
				card?.getAttribute("data-tags")?.split(",") || [];

			const matchTag =
				activeTag === "all" || projectTags.includes(activeTag || "");
			const matchSearch = title.includes(searchTerm);

			if (matchTag && matchSearch) {
				(item as HTMLElement).style.display = "block";
			} else {
				(item as HTMLElement).style.display = "none";
			}
		});

		// Hide empty sections
		sections.forEach((section) => {
			const visibleItems = section.querySelectorAll(
				'.project-item[style="display: block;"], .project-item:not([style*="display: none"])',
			);
			if (visibleItems.length === 0) {
				(section as HTMLElement).style.display = "none";
			} else {
				(section as HTMLElement).style.display = "block";
			}
		});
	}

	filterTags.forEach((btn) => {
		btn.addEventListener("click", () => {
			filterTags.forEach((b) => b.classList.toggle("active", b === btn));
			filterProjects();
		});
	});

	searchInput?.addEventListener("input", filterProjects);
</script>

<style>
	.category-section {
		margin-bottom: 4rem;
		padding: 2rem 0;
		border-bottom: 1px solid var(--gray-800);
	}

	.category-section:last-of-type {
		border-bottom: none;
	}

	.section-header {
		margin-bottom: 2rem;
		text-align: center;
	}

	.section-title {
		font-size: var(--text-3xl);
		font-weight: 700;
		color: var(--gray-0);
		margin-bottom: 0.75rem;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.75rem;
	}

	.icon {
		font-size: 1.5em;
	}

	.section-description {
		font-size: var(--text-lg);
		color: var(--gray-0);
		max-width: 50ch;
		margin: 0 auto;
		line-height: 1.6;
	}

	@media (min-width: 50em) {
		.category-section {
			padding: 3rem 0;
		}

		.section-title {
			font-size: var(--text-4xl);
		}

		.section-header {
			margin-bottom: 3rem;
		}
	}

	.search-container {
		position: relative;
		max-width: 400px;
		margin: 0 auto 1.5rem auto;
	}

	.search-container input {
		width: 100%;
		padding: 0.75rem 1rem 0.75rem 2.5rem;
		border-radius: 9999px;
		border: 1px solid var(--gray-800);
		background: var(--surface-2);
		color: var(--gray-200);
		font-size: var(--text-base);
		transition: all 0.2s ease;
	}

	.search-container input:focus {
		outline: none;
		border-color: var(--accent-regular);
		box-shadow: 0 0 0 2px var(--accent-regular);
	}

	.search-icon {
		position: absolute;
		left: 1rem;
		top: 50%;
		transform: translateY(-50%);
		color: var(--gray-400);
		pointer-events: none;
	}

	.filter-container {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		justify-content: center;
		margin-bottom: 2rem;
	}

	.filter-tag {
		background: var(--surface-2);
		color: var(--text-main);
		border: 1px solid var(--gray-800);
		padding: 0.5rem 1rem;
		border-radius: 9999px;
		cursor: pointer;
		transition: all 0.2s ease;
		font-size: var(--text-sm);
	}

	.filter-tag:hover,
	.filter-tag.active {
		background: var(--accent-regular);
		color: white;
		border-color: var(--accent-regular);
	}
</style>
